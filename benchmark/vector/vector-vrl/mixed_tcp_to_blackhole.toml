[sources.syslog_input]
type = "socket"
address = "127.0.0.1:19001"
mode = "tcp"
max_length = 10485760

# 判断日志类型并路由到不同分支
[transforms.route_logs]
type = "route"
inputs = ["syslog_input"]
route.aws = 'exists(.message) && starts_with(string!(.message), "http")'  # 检测 AWS ALB 日志开头
route.nginx = 'exists(.message) && is_ipv4(to_string(split(string!(.message), " ")[0]))' # 检测 IP 开头（Nginx）
route.apt = 'exists(.message) && starts_with(string!(.message), "#")'  # 检测 Hillstone ANTI-APT 日志
route.sysmon = "exists(.message) && match(string!(.message), r'Microsoft-Windows-Sysmon')" # 检测 Sysmon 日志

# 解析 aws 日志
[transforms.parse_aws]
type = "remap"
inputs = ["route_logs.aws"]
source = '''
  . |= parse_regex!(.message, r'^(?P<symbol>\S+) (?P<timestamp>\S+) (?P<elb>\S+) (?P<client_host>\S+) (?P<target_host>\S+) (?P<request_processing_time>[-\d\.]+) (?P<target_processing_time>[-\d\.]+) (?P<response_processing_time>[-\d\.]+) (?P<elb_status_code>\S+) (?P<target_status_code>\S+) (?P<received_bytes>\d+) (?P<sent_bytes>\d+) "(?P<request_method>\S+) (?P<request_url>[^ ]+) (?P<request_protocol>[^"]+)" "(?P<user_agent>[^"]*)" "(?P<ssl_cipher>[^"]*)" "(?P<ssl_protocol>[^"]*)" (?P<target_group_arn>\S+) "(?P<trace_id>[^"]*)" "(?P<domain_name>[^"]*)" "(?P<chosen_cert_arn>[^"]*)" (?P<matched_rule_priority>\S+) (?P<request_creation_time>\S+) "(?P<actions_executed>[^"]*)" "(?P<redirect_url>[^"]*)" "(?P<error_reason>[^"]*)" "(?P<target_port_list>[^"]*)" "(?P<target_status_code_list>[^"]*)" "(?P<classification>[^"]*)" "(?P<classification_reason>[^"]*)" (?P<traceability_id>\S+)$')
  del(.message)
'''

# 解析 Nginx 日志
[transforms.parse_nginx]
type = "remap"
inputs = ["route_logs.nginx"]
source = '''
  . |= parse_regex!(.message, r'^(?P<sip>\S+) \S+ \S+ \[(?P<timestamp>[^\]]+)\] "(?P<http_request>[^"]*)" (?P<status>\d{3}) (?P<size>\d+) "(?P<referer>[^"]*)" "(?P<http_agent>[^"]*)"')
  del(.message)
'''

# 解析 Hillstone ANTI-APT 日志
[transforms.parse_apt]
type = "remap"
inputs = ["route_logs.apt"]
source = '''
  . |= parse_regex!(.message, r'(?s)^#(?P<timestamp>\w+\s+\d+\s+\d{4}\s+\d{2}:\d{2}:\d{2}[+-]\d{2}:\d{2})\s+(?P<Hostname>\S+)\s+%%(?P<ModuleName>\d+[^/]+)/(?P<SeverityHeader>\d+)/(?P<symbol>[^(]+)\((?P<type>[^)]+)\)\[(?P<Count>\d+)\]:\s*(?P<Content>[^()]+?)\s*\(SyslogId=(?P<SyslogId>[^,]+),\s+VSys="(?P<VSys>[^"]+)",\s+Policy="(?P<Policy>[^"]+)",\s+SrcIp=(?P<SrcIp>[^,]+),\s+DstIp=(?P<DstIp>[^,]+),\s+SrcPort=(?P<SrcPort>[^,]+),\s+DstPort=(?P<DstPort>[^,]+),\s+SrcZone=(?P<SrcZone>[^,]+),\s+DstZone=(?P<DstZone>[^,]+),\s+User="(?P<User>[^"]+)",\s+Protocol=(?P<Protocol>[^,]+),\s+Application="(?P<Application>[^"]+)",\s+Profile="(?P<Profile>[^"]+)",\s+Direction=(?P<Direction>[^,]+),\s+ThreatType=(?P<ThreatType>[^,]+),\s+ThreatName=(?P<ThreatName>[^,]+),\s+Action=(?P<Action>[^,]+),\s+FileType=(?P<FileType>[^,]+),\s+Hash=(?P<Hash>.*)\)$')
  del(.message)
'''

# 解析 sysmon 日志
[transforms.parse_sysmon]
type = "remap"
inputs = ["route_logs.sysmon"]
source = '''
  parsed_msg = parse_regex!(.message, r'^[^{]*(?P<body>\{.*)$')
  .|= parse_regex!(parsed_msg.body, r'(?s)\{"Id":(?P<id>[^,]+),"Version":(?P<Version>[^,]+),"Level":(?P<severity>[^,]+),"Task":(?P<Task>[^,]+),"Opcode":(?P<Opcode>[^,]+),"Keywords":(?P<keywords>[^,]+),"RecordId":(?P<RecordId>[^,]+),"ProviderName":"(?P<ProviderName>[^"]*)","ProviderId":"(?P<ProviderId>[^"]*)","LogName":"(?P<LogName>[^"]*)","ProcessId":(?P<process_id>[^,]+),"ThreadId":(?P<ThreadId>[^,]+),"MachineName":"(?P<MachineName>[^"]*)","TimeCreated":"(?P<TimeCreated>[^"]*)","ActivityId":(?:(?P<ActivityId>[^,]+)|null),"RelatedActivityId":(?P<RelatedActivityId>[^,]+),"Qualifiers":(?P<Qualifiers>[^,]+),"LevelDisplayName":"(?P<LevelDisplayName>[^"]*)","OpcodeDisplayName":"(?P<OpcodeDisplayName>[^"]*)","TaskDisplayName":"(?P<TaskDisplayName>[^"]*)","Description":\{"RuleName":"(?P<rule_name>[^"]*)","UtcTime":"(?P<occur_time>[^"]*)","ProcessGuid":"(?P<process_guid>[^"]*)","ProcessId":"(?P<ProcessId>[^"]*)","Image":"(?P<process_path>[^"]*)","FileVersion":"(?P<file_version>[^"]*)","Description":"(?P<process_desc>[^"]*)","Product":"(?P<product_name>[^"]*)","Company":"(?P<product_company>[^"]*)","OriginalFileName":"(?P<origin_file_name>[^"]*)","CommandLine":"(?P<cmd_line>[^"]*)","CurrentDirectory":"(?P<current_dir>[^"]*)","User":"(?P<user_name>[^"]*)","LogonGuid":"(?P<logon_guid>[^"]*)","LogonId":"(?P<logon_id>[^"]*)","TerminalSessionId":"(?P<terminal_session_id>[^"]*)","IntegrityLevel":"(?P<integrity_level>[^"]*)","Hashes":"(?P<Hashes>[^"]*)","ParentProcessGuid":"(?P<parent_process_guid>[^"]*)","ParentProcessId":"(?P<parent_process_id>[^"]*)","ParentImage":"(?P<parent_process_path>[^"]*)","ParentCommandLine":"(?P<parent_cmd_line>[^"]*)","ParentUser":"(?P<parent_process_user>[^"]*)"\},"DescriptionRawMessage":"(?P<DescriptionRawMessage>[^"]*)"\}$')
  del(.RecordId)
  del(.ActivityId)
  del(.RelatedActivityId)
  del(.Qualifiers)
  del(.message)
'''

[sinks.blackhole_output]
type = "blackhole"
inputs = ["parse_aws", "parse_nginx", "parse_apt", "parse_sysmon", "route_logs._unmatched"]

[api]
    enabled = true
