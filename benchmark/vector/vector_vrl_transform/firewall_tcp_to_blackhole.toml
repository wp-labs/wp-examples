[sources.tcp_in]
type = "socket"
address = "127.0.0.1:19001"
mode = "tcp"
max_length = 10485760

[transforms.parse_barracuda_activity]
type = "remap"
inputs = ["tcp_in"]
source = '''
raw = to_string!(.message)
m = parse_regex!(raw,r'^(?P<ts>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\s+(?P<severity>\S+)\s+(?P<tz>[+-]\d{2}:\d{2})\s+(?P<label>Block|Allow|Drop|Reject):\s+(?P<kv>.*)$')
.timestamp = m.ts
. |= parse_key_value!(m.kv,field_delimiter: "|",key_value_delimiter: "=")

.ipVersion = to_int!(.ipVersion)
.packetCount = to_int!(.packetCount)           
if .proto == "UDP" {
    .enrich_level = "0"
} else if .host != "TCP" {
    .enrich_level = "1"
}   
.extends = {
    "srcIP": .srcIP,
    "srcPort": .srcPort,
}
.extends_dir = {
    "url": .url,
    "urlCategory": .urlCategory,
}
if .srcIP == "10.17.34.12" {
    .match_chars = "internal"
} else if .srcIP != "10.17.34.12"{
    .match_chars = "external"
} 
.num_range = if .ipVersion >= 0 && .ipVersion <= 1000 {
    .ipVersion
} else {
    0
}

del(.message)
'''

[sinks.file_out]
type = "blackhole"
inputs = ["parse_barracuda_activity"]

[api]
    enabled = true