input {
  tcp {
    host => "127.0.0.1"
    port => 19001
    mode => "server"
    codec => line { charset => "UTF-8" }
    add_field => { "source_type" => "socket" }
  }
}

filter {
  if [message] =~ /^http\s/ {
    dissect {
      mapping => {
        "message" => '%{symbol} %{timestamp} %{elb} %{client_host} %{target_host} %{request_processing_time} %{target_processing_time} %{response_processing_time} %{elb_status_code} %{target_status_code} %{received_bytes} %{sent_bytes} "%{raw_request}" "%{user_agent}" "%{ssl_cipher}" "%{ssl_protocol}" %{target_group_arn} "%{trace_id}" "%{domain_name}" "%{chosen_cert_arn}" %{matched_rule_priority} %{request_creation_time} "%{actions_executed}" "%{redirect_url}" "%{error_reason}" "%{target_port_list}" "%{target_status_code_list}" "%{classification}" "%{classification_reason}" %{traceability_id}'
      }
      tag_on_failure => ["aws_dissect_failure"]
    }

    dissect {
      mapping => {
        "raw_request" => "%{request_method} %{request_url} %{request_protocol}"
      }
      tag_on_failure => ["aws_request_failure"]
    }

    if "aws_dissect_failure" in [tags] or "aws_request_failure" in [tags] {
      drop { }
    }

    mutate {
      remove_field => ["message","@timestamp","@version","event","[event][original]","raw_request"]
    }
  } else if [message] =~ /^[0-9]{1,3}\./ {
    dissect {
      mapping => {
        "message" => '%{sip} - - [%{timestamp}] "%{http_request}" %{status} %{size} "%{referer}" "%{http_agent}"'
      }
      tag_on_failure => ["nginx_dissect_failure"]
    }

    if "nginx_dissect_failure" in [tags] {
      drop { }
    }

    mutate {
      remove_field => ["message","@timestamp","@version","event","[event][original]"]
    }
  } else if [message] =~ /^#?[A-Za-z]{3}\s+\d{1,2}\s+\d{4}\s+\d{2}:\d{2}:\d{2}\+\d{2}:\d{2}\s+\S+\s+%%/ {
    mutate { copy => { "message" => "raw" } }

  mutate {
    gsub => [ "raw", "^#", "" ]
  }


  grok {
    match => {
      "raw" => [
        "^(?<timestamp>[A-Za-z]{3}\s+\d{1,2}\s+\d{4}\s+\d{2}:\d{2}:\d{2}\+\d{2}:\d{2})\s+(?<Hostname>\S+)\s+%%(?<ModuleName>[^/]+)/(?<SeverityHeader>\d+)/(?<symbol>[^(]+)\((?<type>[^)]+)\)\[(?<Count>\d+)\]:\s+(?<Content>.*?)\s+\((?<kv_pairs>.*)\)\s*$"
      ]
    }
    tag_on_failure => ["_grokfailure"]
  }


  kv {
    source => "kv_pairs"
    target => ""
    value_split => "="
    field_split_pattern => ", (?=[A-Za-z][A-Za-z0-9_]*=)"
    trim_key => " "
    trim_value => " \""
    remove_char_value => "\""
  }

  if [ExtraInfo] and [Hash] {

  mutate {
    gsub => [
      "ExtraInfo", "\\\\\"", "\""
    ]
  }

  mutate {
    replace => { "Hash" => "%{Hash}, ExtraInfo=\"%{ExtraInfo}\"" }
    remove_field => ["ExtraInfo"]
  }
}


  mutate {
    remove_field => ["raw", "kv_pairs"]
  }

  mutate {
    remove_field => ["@timestamp", "@version", "[event]","message"]
  }
  } else if [message] =~ /Microsoft-Windows-Sysmon/ {
    dissect {
      mapping => {
        "message" => "<%{?pri}>%{?syslog_month} %{?syslog_day} %{?syslog_time} %{?forwarder} %{?prefix_provider}:%{json_body}"
      }
      tag_on_failure => ["sysmon_prefix_dissect_failure"]
    }

    if "sysmon_prefix_dissect_failure" in [tags] {
      drop { }
    }

    json {
      source => "json_body"
      tag_on_failure => ["sysmon_json_failure"]
    }

    if "sysmon_json_failure" in [tags] {
      drop { }
    }

    mutate {
      add_field => { "process_id" => "%{ProcessId}" }

      rename => {
        "[Description][RuleName]"         => "rule_name"
        "[Description][UtcTime]"          => "occur_time"
        "[Description][ProcessGuid]"      => "process_guid"
        "[Description][ProcessId]"        => "ProcessId"
        "[Description][Image]"            => "process_path"
        "[Description][FileVersion]"      => "file_version"
        "[Description][Description]"      => "process_desc"
        "[Description][Product]"          => "product_name"
        "[Description][Company]"          => "product_company"
        "[Description][OriginalFileName]" => "origin_file_name"
        "[Description][CommandLine]"      => "cmd_line"
        "[Description][CurrentDirectory]" => "current_dir"
        "[Description][User]"             => "user_name"
        "[Description][LogonGuid]"        => "logon_guid"
        "[Description][LogonId]"          => "logon_id"
        "[Description][TerminalSessionId]"=> "terminal_session_id"
        "[Description][IntegrityLevel]"   => "integrity_level"
        "[Description][Hashes]"           => "Hashes"
        "[Description][ParentProcessGuid]"=> "parent_process_guid"
        "[Description][ParentProcessId]"  => "parent_process_id"
        "[Description][ParentImage]"      => "parent_process_path"
        "[Description][ParentCommandLine]"=> "parent_cmd_line"
        "[Description][ParentUser]"       => "parent_process_user"

        "Id"        => "id"
        "Level"     => "severity"
        "Keywords"  => "keywords"
      }
    }

    mutate {
      convert => {
        "id"        => "string"
        "severity"  => "string"
        "keywords"  => "string"

        "Opcode"    => "string"
        "Task"      => "string"
        "ThreadId"  => "string"
        "Version"   => "string"
        "ProcessId" => "string"
      }
    }

    mutate {
      remove_field => [
        "Description",
        "RecordId",
        "ActivityId",
        "RelatedActivityId",
        "Qualifiers",

        "pri","syslog_month","syslog_day","syslog_time",
        "forwarder","prefix_provider","json_body","message",

        "@timestamp","@version","event","[event][original]"
      ]
    }
  } else {
    drop { }
  }
}

output {
  file {
    path => "/Users/dy_xuyuhao/wp-example/benchmark/logstash_parse/out.json"
    codec => json_lines
  }
}
