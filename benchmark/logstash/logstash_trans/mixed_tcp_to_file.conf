input {
  tcp {
    host => "127.0.0.1"
    port => 19001
    mode => "server"
    codec => line { charset => "UTF-8" }
    add_field => {
      "source_type" => "socket"
      "src_ip"      => "127.0.0.1"
    }
  }
}

filter {
  if [message] =~ /^http\s/ {
    dissect {
    mapping => {
      "message" => '%{symbol} %{timestamp} %{elb} %{client_host} %{target_host} %{request_processing_time} %{target_processing_time} %{response_processing_time} %{elb_status_code} %{target_status_code} %{received_bytes} %{sent_bytes} "%{raw_request}" "%{user_agent}" "%{ssl_cipher}" "%{ssl_protocol}" %{target_group_arn} "%{trace_id}" "%{domain_name}" "%{chosen_cert_arn}" %{matched_rule_priority} %{request_creation_time} "%{actions_executed}" "%{redirect_url}" "%{error_reason}" "%{target_port_list}" "%{target_status_code_list}" "%{classification}" "%{classification_reason}" %{traceability_id}'
    }
  }

  dissect {
    mapping => {
      "raw_request" => "%{request_method} %{request_url} %{request_protocol}"
    }
    tag_on_failure => ["aws_raw_request_dissect_failure"]
  }

    mutate {
    convert => {
      "client_port"              => "integer"
      "target_port"              => "integer"
      "request_processing_time"  => "float"
      "target_processing_time"   => "float"
      "response_processing_time" => "float"
      "elb_status_code"          => "integer"
      "target_status_code"       => "integer"
      "received_bytes"           => "integer"
      "sent_bytes"               => "integer"
      "matched_rule_priority"    => "integer"
    }
  }
  mutate {
    add_field => {
      "[extends][ssl_cipher]"   => "%{ssl_cipher}"
      "[extends][ssl_protocol]" => "%{ssl_protocol}"
    }
  }

  if [src_ip] == "127.0.0.1" {
    mutate { add_field => { "match_chars" => "localhost" } }
  } else {
    mutate { add_field => { "match_chars" => "attack_ip" } }
  }

  if [elb_status_code] == 200 {
    mutate { add_field => { "str_elb_status" => "ok" } }
  } else if [elb_status_code] == 404 {
    mutate { add_field => { "str_elb_status" => "not_found" } }
  } else {
    mutate { add_field => { "str_elb_status" => "error" } }
  }

  mutate {
    remove_field => ["message","raw_request","@timestamp","@version","event","[event][original]"]
  }
  } else if [message] =~ /^[0-9]{1,3}\./ {
    dissect {
      mapping => {
        "message" => '%{sip} - - [%{timestamp}] "%{http_request}" %{status} %{size} "%{referer}" "%{http_agent}"'
      }
    }

  mutate {
    convert => {
      "status" => "integer"
      "size"   => "integer"
    }
  }

  if [src_ip] == "127.0.0.1" {
    mutate { add_field => { "match_chars" => "localhost" } }
  } else {
    mutate { add_field => { "match_chars" => "attack_ip" } }
  }

  if [status] == 200 {
    mutate { add_field => { "str_status" => "OK" } }
  } else if [status] == 500 {
    mutate { add_field => { "str_status" => "Internal Server Error" } }
  } 

  mutate {
    remove_field => ["message", "@timestamp", "@version", "event", "[event][original]"]
  }
  } else if [message] =~ /^#/ {
    mutate { copy => { "message" => "raw" } }

  mutate {
    gsub => [ "raw", "^#", "" ]
  }

  grok {
    match => {
      "raw" => [
        "^(?<timestamp>[A-Za-z]{3}\s+\d{1,2}\s+\d{4}\s+\d{2}:\d{2}:\d{2}\+\d{2}:\d{2})\s+(?<Hostname>\S+)\s+%%(?<ModuleName>[^/]+)/(?<SeverityHeader>\d+)/(?<symbol>[^(]+)\((?<type>[^)]+)\)\[(?<Count>\d+)\]:\s+(?<Content>.*?)\s+\((?<kv_pairs>.*)\)\s*$"
      ]
    }
    tag_on_failure => ["_grokfailure"]
  }

  kv {
    source => "kv_pairs"
    target => ""
    value_split => "="
    field_split_pattern => ", (?=[A-Za-z][A-Za-z0-9_]*=)"
    trim_key => " "
    trim_value => " \""
    remove_char_value => "\""
  }

  if [ExtraInfo] and [Hash] {

  mutate {
    gsub => [
      "ExtraInfo", "\\\\\"", "\""
    ]
  }

  mutate {
    replace => { "Hash" => "%{Hash}, ExtraInfo=\"%{ExtraInfo}\"" }
    remove_field => ["ExtraInfo"]
  }
}

  mutate {
    remove_field => ["raw", "kv_pairs"]
  }

mutate {
  convert => {
    "SeverityHeader" => "integer"
    "Count"          => "integer"
  }
}

mutate {
  add_field => { "severity" => "%{SeverityHeader}" }
}
mutate { convert => { "severity" => "integer" } }


if [src_ip] == "127.0.0.1" {
  mutate { add_field => { "match_chars" => "localhost" } }
} else {
  mutate { add_field => { "match_chars" => "attack_ip" } }
}

if [type] == "l" {
  mutate { add_field => { "src_system_log_type" => "日志信息" } }
} else if [type] == "s" {
  mutate { add_field => { "src_system_log_type" => "安全日志信息" } }
}

mutate {
  add_field => {
    "[extends_ip][DstIp]" => "%{DstIp}"
    "[extends_ip][SrcIp]" => "%{SrcIp}"
  }
}

mutate {
  add_field => {
    "[extends_info][hostname]"    => "%{Hostname}"
    "[extends_info][source_type]" => "%{source_type}"
  }
}

if [Count] and [Count] >= 0 and [Count] <= 1000 {
  mutate { add_field => { "num_range" => "%{Count}" } }
} else {
  mutate { add_field => { "num_range" => "0" } }
}
mutate { convert => { "num_range" => "integer" } }

  mutate {
    remove_field => ["@timestamp", "@version", "[event]","message"]
  }
  } else if [message] =~ /^\s*(?:<\d+>)?\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\s+/ {
    mutate {
      gsub => ["message", "\r$", ""]
    }

    grok {
      match => {
        "message" => [
          "^\\s*(?:<\\d+>)?(?<timestamp>\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2})\\s+(?<severity>\\S+)\\s+(?<tz>[+-]\\d{2}:\\d{2})\\s+(?<label>[^:]+):\\s+%{GREEDYDATA:body}$"
        ]
      }
      tag_on_failure => ["firewall_grok_failure"]
    }

    if "firewall_grok_failure" in [tags] {
      dissect {
        mapping => {
          "message" => "%{timestamp} %{severity} %{tz} %{label}: %{body}"
        }
        tag_on_failure => ["firewall_dissect_failure"]
      }
      if "firewall_dissect_failure" not in [tags] {
        mutate {
          remove_tag => ["firewall_grok_failure", "firewall_dissect_failure"]
        }
      }
    }

    if "firewall_grok_failure" in [tags] or "firewall_dissect_failure" in [tags] {
      drop { }
    }

    kv {
      source => "body"
      field_split => "|"
      value_split => "="
      trim_key => " "
      trim_value => " "
      allow_empty_values => true
    }

    mutate {
      convert => {
        "ipVersion" => "integer"
        "packetCount" => "integer"
      }
    }

    if [proto] == "UDP"  {
      mutate { add_field => { "enrich_level" => "0" } }
    } else if [proto] == "TCP" {
      mutate { add_field => { "enrich_level" => "1" } }
    }

    mutate {
      add_field => {
        "[extends][srcIP]"  => "%{srcIP}"
        "[extends][srcPort]" => "%{srcPort}"
      }
    }

    mutate {
      add_field => {
        "[extends_dir][url]" => "%{url}"
        "[extends_dir][urlCategory]" => "%{urlCategory}"
      }
    }

    if [srcIP] == "10.17.34.12" {
      mutate { add_field => { "match_chars" => "internal" } }
    } else {
      mutate { add_field => { "match_chars" => "external" } }
    }

    if [ipVersion] and [ipVersion] >= 0 and [ipVersion] <= 1000 {
      mutate { add_field => { "num_range" => "%{ipVersion}" } }
    } else {
      mutate { add_field => { "num_range" => "0" } }
    }
    mutate { convert => { "num_range" => "integer" } }

    mutate {
      remove_field => [
        "severity",
        "tz",
        "label",
        "body",
        "message",
        "@version",
        "host",
        "event",
        "@timestamp",
        "[event][original]"
      ]
    }
  }
}

output {
  file {
    path => "/Users/dy_xuyuhao/wp-examples/benchmark/logstash/logstash_trans/out.json"
    codec => "json_lines"
  }
}
