input {
  tcp {
    host => "127.0.0.1"
    port => 19001
    mode => "server"
    codec => line { charset => "UTF-8" }
    add_field => {
      "source_type" => "socket"
      "src_ip"      => "127.0.0.1"
    }
  }
}

filter {
  # =========================
  # 解析段：完全沿用你现有 sysmon_syslog_to_file.conf 的写法（不改动）
  # =========================
  dissect {
    mapping => {
      "message" => "<%{?pri}>%{?syslog_month} %{?syslog_day} %{?syslog_time} %{?forwarder} %{?prefix_provider}:%{json_body}"
    }
    tag_on_failure => ["sysmon_prefix_dissect_failure"]
  }

  json {
    source => "json_body"
    tag_on_failure => ["sysmon_json_failure"]
  }

  mutate {
    add_field => { "process_id" => "%{ProcessId}" }
    rename => {
      "[Description][RuleName]"         => "rule_name"
      "[Description][UtcTime]"          => "occur_time"
      "[Description][ProcessGuid]"      => "process_guid"
      "[Description][ProcessId]"        => "ProcessId"
      "[Description][Image]"            => "process_path"
      "[Description][FileVersion]"      => "file_version"
      "[Description][Description]"      => "process_desc"
      "[Description][Product]"          => "product_name"
      "[Description][Company]"          => "product_company"
      "[Description][OriginalFileName]" => "origin_file_name"
      "[Description][CommandLine]"      => "cmd_line"
      "[Description][CurrentDirectory]" => "current_dir"
      "[Description][User]"             => "user_name"
      "[Description][LogonGuid]"        => "logon_guid"
      "[Description][LogonId]"          => "logon_id"
      "[Description][TerminalSessionId]"=> "terminal_session_id"
      "[Description][IntegrityLevel]"   => "integrity_level"
      "[Description][Hashes]"           => "Hashes"
      "[Description][ParentProcessGuid]"=> "parent_process_guid"
      "[Description][ParentProcessId]"  => "parent_process_id"
      "[Description][ParentImage]"      => "parent_process_path"
      "[Description][ParentCommandLine]"=> "parent_cmd_line"
      "[Description][ParentUser]"       => "parent_process_user"
      "Id"                              => "id"
      "Level"                           => "severity"
      "Keywords"                        => "keywords"
    }
  }

  mutate {
    convert => {
      "id"        => "string"
      "severity"  => "string"
      "keywords"  => "string"
      "Opcode"    => "string"
      "Task"      => "string"
      "ThreadId"  => "string"
      "Version"   => "string"
      "ProcessId" => "string"
    }
  }

 # =========================
# Sysmon Transform（对齐你 Vector 逻辑）
# 插入位置：解析完成后 / remove_field 前
# =========================

# 0)（建议）保证数值比较可用：Id 转 integer（否则范围判断会变成字符串比较）
mutate {
  convert => {
    "Id" => "integer"
  }
}

# 1) match_chars：对齐 Vector 的 host 判断
# Vector: if .host == "127.0.0.1" => localhost else attack_ip
if [src_ip] == "127.0.0.1" {
  mutate { add_field => { "match_chars" => "localhost" } }
} else {
  mutate { add_field => { "match_chars" => "attack_ip" } }
}

# 2) enrich_level：对齐 Vector 逻辑
# Vector:
# if .severity == "4" => "severity"
# else if .Level == "3" => "normal"
if [severity] == "4" or [Level] == "4" {
  mutate { add_field => { "enrich_level" => "severity" } }
} else if [Level] == "3" or [severity] == "3" {
  mutate { add_field => { "enrich_level" => "normal" } }
}

# 3) extends：对齐 Vector 的聚合对象
# .extends = { "OriginalFileName": .origin_file_name, "ParentCommandLine": .parent_cmd_line }
mutate {
  add_field => {
    "[extends][OriginalFileName]"  => "%{origin_file_name}"
    "[extends][ParentCommandLine]" => "%{parent_cmd_line}"
  }
}

# 4) extends_dir：第二个聚合对象（对齐 Vector）
# .extends_dir = { "ParentProcessPath": .parent_process_path, "Process_path": .process_path }
mutate {
  add_field => {
    "[extends_dir][ParentProcessPath]" => "%{parent_process_path}"
    "[extends_dir][Process_path]"      => "%{process_path}"
  }
}

# 5) num_range：范围判断（对齐 Vector）
# .num_range = if .Id >= 0 && .Id <= 1000 { .Id } else { 0 }
if [Id] and [Id] >= 0 and [Id] <= 1000 {
  mutate { add_field => { "num_range" => "%{Id}" } }
} else {
  mutate { add_field => { "num_range" => "0" } }
}

mutate { convert => { "num_range" => "integer" } }
  mutate {
    remove_field => [
      "Description",
      "RecordId",
      "ActivityId",
      "RelatedActivityId",
      "Qualifiers",
      "pri","syslog_month","syslog_day","syslog_time",
      "forwarder","prefix_provider","json_body","message",
      "@timestamp","@version","event","[event][original]"
    ]
  }
}

output {
  file { path => "/dev/null" codec => "json_lines" }
}