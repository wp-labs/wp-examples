input {
  file {
    path => ["in_data/simple_nginx_239B"]
    start_position => "beginning"
    sincedb_path => "/dev/null"
    add_field => {
      "src_ip"      => "127.0.0.1"
    }
  }
}

filter {
  # 1) 解析：对齐你当前的 nginx dissect 字段
  dissect {
    mapping => {
      "message" => '%{sip} - - [%{timestamp}] "%{http_request}" %{status} %{size} "%{referer}" "%{http_agent}"'
    }
  }

  # 2) 类型转换：对齐 Vector 的 to_int
  mutate {
    convert => {
      "status" => "integer"
      "size"   => "integer"
    }
  }

  # 3) 派生字段：对齐 Vector 示例里的 match_chars / str_status
  # match_chars：根据 tcp 对端 host 判断
  if [src_ip] == "127.0.0.1" {
    mutate { add_field => { "match_chars" => "localhost" } }
  } else {
    mutate { add_field => { "match_chars" => "attack_ip" } }
  }

  # str_status：按 status 映射（你 Vector 里出现了 500 / 404，我补了常见的 200）
  if [status] == 200 {
    mutate { add_field => { "str_status" => "OK" } }
  } else if [status] == 500 {
    mutate { add_field => { "str_status" => "Internal Server Error" } }
  } 

  # 4) 清理无关字段：保持你的压测输出干净
  mutate {
    remove_field => ["message", "@timestamp", "@version", "event", "[event][original]"]
  }
}

output {
  file { path => "/dev/null" codec => "json_lines" }
}
