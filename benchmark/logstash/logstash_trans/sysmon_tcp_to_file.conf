input {
  tcp {
    host => "127.0.0.1"
    port => 19001
    mode => "server"
    codec => line { charset => "UTF-8" }

    # 显式注入，避免依赖 host 结构（与你 AWS 的方案一致）
    add_field => {
      "source_type" => "socket"
      "src_ip"      => "127.0.0.1"
    }

    ecs_compatibility => "disabled"
  }
}

filter {
  dissect {
    mapping => {
      "message" => "<%{?pri}>%{?syslog_month} %{?syslog_day} %{?syslog_time} %{?forwarder} %{?prefix_provider}:%{json_body}"
    }
    tag_on_failure => ["sysmon_prefix_dissect_failure"]
  }

  json {
    source => "json_body"
    tag_on_failure => ["sysmon_json_failure"]
  }

  mutate {
    add_field => { "process_id" => "%{ProcessId}" }
    rename => {
      "[Description][RuleName]"         => "rule_name"
      "[Description][UtcTime]"          => "occur_time"
      "[Description][ProcessGuid]"      => "process_guid"
      "[Description][ProcessId]"        => "ProcessId"
      "[Description][Image]"            => "process_path"
      "[Description][FileVersion]"      => "file_version"
      "[Description][Description]"      => "process_desc"
      "[Description][Product]"          => "product_name"
      "[Description][Company]"          => "product_company"
      "[Description][OriginalFileName]" => "origin_file_name"
      "[Description][CommandLine]"      => "cmd_line"
      "[Description][CurrentDirectory]" => "current_dir"
      "[Description][User]"             => "user_name"
      "[Description][LogonGuid]"        => "logon_guid"
      "[Description][LogonId]"          => "logon_id"
      "[Description][TerminalSessionId]"=> "terminal_session_id"
      "[Description][IntegrityLevel]"   => "integrity_level"
      "[Description][Hashes]"           => "Hashes"
      "[Description][ParentProcessGuid]"=> "parent_process_guid"
      "[Description][ParentProcessId]"  => "parent_process_id"
      "[Description][ParentImage]"      => "parent_process_path"
      "[Description][ParentCommandLine]"=> "parent_cmd_line"
      "[Description][ParentUser]"       => "parent_process_user"
      "Id"                              => "id"
      "Level"                           => "severity"
      "Keywords"                        => "keywords"
    }
  }

  mutate {
    convert => {
      "id"        => "string"
      "severity"  => "string"
      "keywords"  => "string"
      "Opcode"    => "string"
      "Task"      => "string"
      "ThreadId"  => "string"
      "Version"   => "string"
      "ProcessId" => "string"
    }
  }

mutate {
  convert => {
    "Id" => "integer"
  }
}

if [src_ip] == "127.0.0.1" {
  mutate { add_field => { "match_chars" => "localhost" } }
} else {
  mutate { add_field => { "match_chars" => "attack_ip" } }
}

if [severity] == "4" or [Level] == "4" {
  mutate { add_field => { "enrich_level" => "severity" } }
} else if [Level] == "3" or [severity] == "3" {
  mutate { add_field => { "enrich_level" => "normal" } }
}

mutate {
  add_field => {
    "[extends][OriginalFileName]"  => "%{origin_file_name}"
    "[extends][ParentCommandLine]" => "%{parent_cmd_line}"
  }
}

mutate {
  add_field => {
    "[extends_dir][ParentProcessPath]" => "%{parent_process_path}"
    "[extends_dir][Process_path]"      => "%{process_path}"
  }
}

if [Id] and [Id] >= 0 and [Id] <= 1000 {
  mutate { add_field => { "num_range" => "%{Id}" } }
} else {
  mutate { add_field => { "num_range" => "0" } }
}

mutate { convert => { "num_range" => "integer" } }
  mutate {
    remove_field => [
      "Description",
      "RecordId",
      "ActivityId",
      "RelatedActivityId",
      "Qualifiers",
      "pri","syslog_month","syslog_day","syslog_time",
      "forwarder","prefix_provider","json_body","message",
      "@timestamp","@version","event","[event][original]"
    ]
  }
}

output {
  file {
    path  => "/Users/dy_xuyuhao/wp-example/benchmark/logstash_trans/out_sysmon_transform.json"
    codec => "json_lines"
  }
}