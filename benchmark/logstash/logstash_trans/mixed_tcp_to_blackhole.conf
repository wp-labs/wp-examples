input {
  tcp {
    host => "127.0.0.1"
    port => 19001
    mode => "server"
    codec => line { charset => "UTF-8" }
    add_field => {
      "source_type" => "socket"
      "src_ip"      => "127.0.0.1"
    }
  }
}

filter {
  if [message] =~ /^http\s/ {
    dissect {
    mapping => {
      "message" => '%{symbol} %{timestamp} %{elb} %{client_host} %{target_host} %{request_processing_time} %{target_processing_time} %{response_processing_time} %{elb_status_code} %{target_status_code} %{received_bytes} %{sent_bytes} "%{raw_request}" "%{user_agent}" "%{ssl_cipher}" "%{ssl_protocol}" %{target_group_arn} "%{trace_id}" "%{domain_name}" "%{chosen_cert_arn}" %{matched_rule_priority} %{request_creation_time} "%{actions_executed}" "%{redirect_url}" "%{error_reason}" "%{target_port_list}" "%{target_status_code_list}" "%{classification}" "%{classification_reason}" %{traceability_id}'
    }
  }

  #
  # 2) 解析 raw_request -> request_method / request_url / request_protocol（你原 conf 里就有这一步）
  #
  dissect {
    mapping => {
      "raw_request" => "%{request_method} %{request_url} %{request_protocol}"
    }
    tag_on_failure => ["aws_raw_request_dissect_failure"]
  }

  #
  # 3) 转换：类型对齐 Vector to_int/to_float 思路
  #
    mutate {
    convert => {
      "client_port"              => "integer"
      "target_port"              => "integer"

      "request_processing_time"  => "float"
      "target_processing_time"   => "float"
      "response_processing_time" => "float"

      "elb_status_code"          => "integer"
      "target_status_code"       => "integer"

      "received_bytes"           => "integer"
      "sent_bytes"               => "integer"

      "matched_rule_priority"    => "integer"
    }
  }
  mutate {
    add_field => {
      "[extends][ssl_cipher]"   => "%{ssl_cipher}"
      "[extends][ssl_protocol]" => "%{ssl_protocol}"
    }
  }

  # 2) match_chars：按你“显式注入字段”的手段来判断（推荐用 src_ip）
  # 你如果已经在 input 里 add_field 了 src_ip，这里就能稳定命中 localhost
  if [src_ip] == "127.0.0.1" {
    mutate { add_field => { "match_chars" => "localhost" } }
  } else {
    mutate { add_field => { "match_chars" => "attack_ip" } }
  }

  # 3) str_elb_status：示例映射（按你 Vector 里类似逻辑）
  if [elb_status_code] == 200 {
    mutate { add_field => { "str_elb_status" => "ok" } }
  } else if [elb_status_code] == 404 {
    mutate { add_field => { "str_elb_status" => "not_found" } }
  } else {
    mutate { add_field => { "str_elb_status" => "error" } }
  }

  #
  # 6) 清理：保持输出干净，对齐 benchmark 输出
  #
  mutate {
    remove_field => ["message","raw_request","@timestamp","@version","event","[event][original]"]
  }
  } else if [message] =~ /^[0-9]{1,3}\./ {
    dissect {
      mapping => {
        "message" => '%{sip} - - [%{timestamp}] "%{http_request}" %{status} %{size} "%{referer}" "%{http_agent}"'
      }
    }

  # 2) 类型转换：对齐 Vector 的 to_int
  mutate {
    convert => {
      "status" => "integer"
      "size"   => "integer"
    }
  }

  # 3) 派生字段：对齐 Vector 示例里的 match_chars / str_status
  # match_chars：根据 tcp 对端 host 判断
  if [src_ip] == "127.0.0.1" {
    mutate { add_field => { "match_chars" => "localhost" } }
  } else {
    mutate { add_field => { "match_chars" => "attack_ip" } }
  }

  # str_status：按 status 映射（你 Vector 里出现了 500 / 404，我补了常见的 200）
  if [status] == 200 {
    mutate { add_field => { "str_status" => "OK" } }
  } else if [status] == 500 {
    mutate { add_field => { "str_status" => "Internal Server Error" } }
  } 

  # 4) 清理无关字段：保持你的压测输出干净
  mutate {
    remove_field => ["message", "@timestamp", "@version", "event", "[event][original]"]
  }
  } else if [message] =~ /^#/ {
    mutate { copy => { "message" => "raw" } }

  mutate {
    gsub => [ "raw", "^#", "" ]
  }


  grok {
    match => {
      "raw" => [
        "^(?<timestamp>[A-Za-z]{3}\s+\d{1,2}\s+\d{4}\s+\d{2}:\d{2}:\d{2}\+\d{2}:\d{2})\s+(?<Hostname>\S+)\s+%%(?<ModuleName>[^/]+)/(?<SeverityHeader>\d+)/(?<symbol>[^(]+)\((?<type>[^)]+)\)\[(?<Count>\d+)\]:\s+(?<Content>.*?)\s+\((?<kv_pairs>.*)\)\s*$"
      ]
    }
    tag_on_failure => ["_grokfailure"]
  }


  kv {
    source => "kv_pairs"
    target => ""
    value_split => "="
    field_split_pattern => ", (?=[A-Za-z][A-Za-z0-9_]*=)"
    trim_key => " "
    trim_value => " \""
    remove_char_value => "\""
  }

  if [ExtraInfo] and [Hash] {

  mutate {
    gsub => [
      "ExtraInfo", "\\\\\"", "\""
    ]
  }

  mutate {
    replace => { "Hash" => "%{Hash}, ExtraInfo=\"%{ExtraInfo}\"" }
    remove_field => ["ExtraInfo"]
  }
}


  mutate {
    remove_field => ["raw", "kv_pairs"]
  }
  # =========================
# APT Transform（对齐 Vector 转换逻辑）
# 插入位置：APT 解析完成后 / remove_field 之前
# =========================

# 1) severity / Count 转数值（对齐 to_int!）
mutate {
  convert => {
    "SeverityHeader" => "integer"
    "Count"          => "integer"
  }
}

# Vector: .severity = to_int!(.SeverityHeader)
mutate {
  add_field => { "severity" => "%{SeverityHeader}" }
}
mutate { convert => { "severity" => "integer" } }

# 2) match_chars（对齐 Vector 的 host 判断）
if [src_ip] == "127.0.0.1" {
  mutate { add_field => { "match_chars" => "localhost" } }
} else {
  mutate { add_field => { "match_chars" => "attack_ip" } }
}

# 3) src_system_log_type（对齐 Vector：type l/s）
if [type] == "l" {
  mutate { add_field => { "src_system_log_type" => "日志信息" } }
} else if [type] == "s" {
  mutate { add_field => { "src_system_log_type" => "安全日志信息" } }
}

# 4) 聚合字段 extends_ip（对齐 Vector）
mutate {
  add_field => {
    "[extends_ip][DstIp]" => "%{DstIp}"
    "[extends_ip][SrcIp]" => "%{SrcIp}"
  }
}

# 5) 聚合字段 extends_info（对齐 Vector）
mutate {
  add_field => {
    "[extends_info][hostname]"    => "%{Hostname}"
    "[extends_info][source_type]" => "%{source_type}"
  }
}

# 6) num_range：Count 范围判断（对齐 Vector）
if [Count] and [Count] >= 0 and [Count] <= 1000 {
  mutate { add_field => { "num_range" => "%{Count}" } }
} else {
  mutate { add_field => { "num_range" => "0" } }
}
mutate { convert => { "num_range" => "integer" } }

  mutate {
    remove_field => ["@timestamp", "@version", "[event]","message"]
  }
  } else if [message] =~ /Microsoft-Windows-Sysmon/ {
    dissect {
    mapping => {
      "message" => "<%{?pri}>%{?syslog_month} %{?syslog_day} %{?syslog_time} %{?forwarder} %{?prefix_provider}:%{json_body}"
    }
    tag_on_failure => ["sysmon_prefix_dissect_failure"]
  }

  json {
    source => "json_body"
    tag_on_failure => ["sysmon_json_failure"]
  }

  mutate {
    add_field => { "process_id" => "%{ProcessId}" }
    rename => {
      "[Description][RuleName]"         => "rule_name"
      "[Description][UtcTime]"          => "occur_time"
      "[Description][ProcessGuid]"      => "process_guid"
      "[Description][ProcessId]"        => "ProcessId"
      "[Description][Image]"            => "process_path"
      "[Description][FileVersion]"      => "file_version"
      "[Description][Description]"      => "process_desc"
      "[Description][Product]"          => "product_name"
      "[Description][Company]"          => "product_company"
      "[Description][OriginalFileName]" => "origin_file_name"
      "[Description][CommandLine]"      => "cmd_line"
      "[Description][CurrentDirectory]" => "current_dir"
      "[Description][User]"             => "user_name"
      "[Description][LogonGuid]"        => "logon_guid"
      "[Description][LogonId]"          => "logon_id"
      "[Description][TerminalSessionId]"=> "terminal_session_id"
      "[Description][IntegrityLevel]"   => "integrity_level"
      "[Description][Hashes]"           => "Hashes"
      "[Description][ParentProcessGuid]"=> "parent_process_guid"
      "[Description][ParentProcessId]"  => "parent_process_id"
      "[Description][ParentImage]"      => "parent_process_path"
      "[Description][ParentCommandLine]"=> "parent_cmd_line"
      "[Description][ParentUser]"       => "parent_process_user"
      "Id"                              => "id"
      "Level"                           => "severity"
      "Keywords"                        => "keywords"
    }
  }

  mutate {
    convert => {
      "id"        => "string"
      "severity"  => "string"
      "keywords"  => "string"
      "Opcode"    => "string"
      "Task"      => "string"
      "ThreadId"  => "string"
      "Version"   => "string"
      "ProcessId" => "string"
    }
  }

 # =========================
# Sysmon Transform（对齐你 Vector 逻辑）
# 插入位置：解析完成后 / remove_field 前
# =========================

# 0)（建议）保证数值比较可用：Id 转 integer（否则范围判断会变成字符串比较）
mutate {
  convert => {
    "Id" => "integer"
  }
}

# 1) match_chars：对齐 Vector 的 host 判断
# Vector: if .host == "127.0.0.1" => localhost else attack_ip
if [src_ip] == "127.0.0.1" {
  mutate { add_field => { "match_chars" => "localhost" } }
} else {
  mutate { add_field => { "match_chars" => "attack_ip" } }
}

# 2) enrich_level：对齐 Vector 逻辑
# Vector:
# if .severity == "4" => "severity"
# else if .Level == "3" => "normal"
if [severity] == "4" or [Level] == "4" {
  mutate { add_field => { "enrich_level" => "severity" } }
} else if [Level] == "3" or [severity] == "3" {
  mutate { add_field => { "enrich_level" => "normal" } }
}

# 3) extends：对齐 Vector 的聚合对象
# .extends = { "OriginalFileName": .origin_file_name, "ParentCommandLine": .parent_cmd_line }
mutate {
  add_field => {
    "[extends][OriginalFileName]"  => "%{origin_file_name}"
    "[extends][ParentCommandLine]" => "%{parent_cmd_line}"
  }
}

# 4) extends_dir：第二个聚合对象（对齐 Vector）
# .extends_dir = { "ParentProcessPath": .parent_process_path, "Process_path": .process_path }
mutate {
  add_field => {
    "[extends_dir][ParentProcessPath]" => "%{parent_process_path}"
    "[extends_dir][Process_path]"      => "%{process_path}"
  }
}

# 5) num_range：范围判断（对齐 Vector）
# .num_range = if .Id >= 0 && .Id <= 1000 { .Id } else { 0 }
if [Id] and [Id] >= 0 and [Id] <= 1000 {
  mutate { add_field => { "num_range" => "%{Id}" } }
} else {
  mutate { add_field => { "num_range" => "0" } }
}

mutate { convert => { "num_range" => "integer" } }
  mutate {
    remove_field => [
      "Description",
      "RecordId",
      "ActivityId",
      "RelatedActivityId",
      "Qualifiers",
      "pri","syslog_month","syslog_day","syslog_time",
      "forwarder","prefix_provider","json_body","message",
      "@timestamp","@version","event","[event][original]"
    ]
  }
}
}

output {
  file { path => "/dev/null" codec => "json_lines" }
}
